project(src)

add_subdirectory(main)
add_subdirectory(app)
add_subdirectory(log)

install(TARGETS
	main

	RUNTIME DESTINATION bin
	LIBRARY DESTINATION bin
	ARCHIVE DESTINATION lib
)
install(TARGETS
	App
	Log

	EXPORT TopConfig
	RUNTIME DESTINATION bin
	LIBRARY DESTINATION bin
	ARCHIVE DESTINATION lib
)
install(DIRECTORY
	${TOP_INCLUDE}

	DESTINATION .
)
install(EXPORT TopConfig
	FILE TopConfig.cmake
	NAMESPACE Top::
	DESTINATION share/Top
)

if(WIN32)
	set(TOP_LIB_SUFFIX "")
endif()
set(INSTALL_TARGET_LIST
	main
	${TOP_LIB_PREFIX}App${TOP_LIB_SUFFIX}
	${TOP_LIB_PREFIX}Log${TOP_LIB_SUFFIX}
)
if(WIN32)
	FIND_TARGET_DEPENDENCIES(TARGET_DEPENDENCIES ${INSTALL_TARGET_LIST})
	FIND_TARGET_LIBRARIES(TARGET_LIBRARIES TARGET_DEPENDENCIES)
	set(DEPEND_DLL
		"${EXECUTABLE_OUTPUT_PATH}/iconv-2.dll"
		$<$<BOOL:${USING_MIMALLOC}>:${EXECUTABLE_OUTPUT_PATH}/mimalloc-redirect.dll>
	)
	install(FILES
		${TARGET_LIBRARIES}
		${DEPEND_DLL}

		DESTINATION bin
	)
elseif(UNIX)
	COPY_TARGET_DEPENDENCIES(INSTALL_TARGET_LIST)
	install(DIRECTORY
		"${CMAKE_INSTALL_PREFIX}/bin"
		DESTINATION .
	)
endif()
